<html>
<head>
</head>
<body>
	<h1>Elm Debugger</h1>
	<!-- <h3>Nodes</h3> -->
	<div><input id="timeSlider" type=range value=0 step=1 min=0 max=0 style="width: 100%"/>
	</div>
	<button id="buttonRestart">Restart</button>
	<button id="buttonPause">Pause</button>
	<button id="buttonContinue" style="display: none;">Continue</button>
	<button id="buttonStep">Step</button>
	<div id="signalGraphView"></div>

<style>
#signalGraphView {
	-webkit-transform: scale(0.7);
	-webkit-transform-origin: 0% 0%;
	-moz-transform: scale(0.5);
	-moz-transform-origin: 0% 0%;
	width: 0;
	height: 0;
}
</style>
<script src="/debugger/viz.js"></script>
<script>
if (!String.prototype.format) {
  String.prototype.format = function() {
    var args = arguments;
    return this.replace(/{(\d+)}/g, function(match, number) { 
      return typeof args[number] != 'undefined'
        ? args[number]
        : match
      ;
    });
  };
}

function findChild(parent, elemType) {
	for (var i = 0; i < parent.childNodes.length; i++) {
		var child = parent.childNodes[i];
		if (child.nodeType == 1 && child.nodeName == elemType) {
			return child;
		}
	}
}

function clearSvgTooltips(nodeList) {
	for (var i = 0; i < nodeList.length; i++) {
		nodeList.item(i).textContent = '';
	}
}

function createSignalGraphView(Elm, elmDebugger) {
	var Prelude = Elm.Prelude.make({});
	function nodeValueToString(node) {
		if (node === elmDebugger.mainNode) {
			return 'main';
		}
		return Prelude.show(node.value);
	}

	var allInputs = filterReachableNodes(elmDebugger.allNodes, elmDebugger.mainNode);
	var nodesById = {};
	allInputs.forEach(function(x) {
		nodesById[x.id] = x;
	});

	var dotLines = [];
 	allInputs.forEach(function(node) {
 		var shape = "ellipse";
 		if (node.nodeType == 'input') {
 			shape = 'hexagon';
 		} else if (node.nodeType == 'lift') {
 			shape = 'invtrapezium';
 		} else if (node.nodeType == 'foldp') {
 			shape = 'rect';
 		} else if (node.nodeType == 'sampleOn') {
 			shape = 'house';
 		} else if (node.nodeType == 'constant') {
 			shape = 'none';
 		} else if (node.nodeType == 'drop') {
 			shape = 'doubleoctagon';
 		}

 		var initialLabel = nodeValueToString(node).replace(/"/g, '_');
 		var labelPadding = new Array(Math.ceil(initialLabel.length/2)).join("_");
 		dotLines.push('{0} [id="svgNode{0}", label="{1}", shape="{2}"];'.format(node.id, initialLabel + labelPadding, shape))

 		node.kids.forEach(function(child) {
 			if (nodesById.hasOwnProperty(child.id)) {
 				var edgeStyle = 'solid';
 				if (child.nodeType == 'sampleOn' && child.indirectParent === node) {
 					edgeStyle = 'dashed';
 				}
				dotLines.push('{0} -> {1} [style="{2}"];'.format(node.id, child.id, edgeStyle));
			}
 		});
	});

	var sceneGraphDiv = document.getElementById('signalGraphView');
	var graphVizString = "digraph {" + dotLines.join('\n') + "}";
	sceneGraphDiv.innerHTML = Viz(graphVizString, "svg");
	clearSvgTooltips(sceneGraphDiv.getElementsByTagName('title'));

	function updateValues() {
		allInputs.forEach(function(node) {
			var dotNode = document.getElementById('svgNode' + node.id);
			findChild(dotNode, 'text').textContent = nodeValueToString(node);
			findChild(dotNode, 'title').textContent = node.id.toString();
		});
	}

	return {
		updateValues: updateValues
	};
};

function filterReachableNodes(nodes, reachTo) {
  function isReachable(node) {
  	if (node === reachTo) {
  		return true;
  	}
  	return node.kids.some(isReachable);
  }
  return nodes.filter(isReachable);
};




var elmDebugger = {
	restart: function() {},
	pause: function() {},
	kontinue: function() {},
	getMaxSteps: function() { return 0; },
	stepTo: function(i) {},
	getPaused: function() { return false; },
	getHotSwapState: function() { return null; }
};

var signalGraphView = {
	updateValues: function() {}
}

var timeSlider = document.getElementById("timeSlider");
timeSlider.addEventListener('change', function(e) {
	console.log("Time sliding");
	elmDebugger.stepTo(+timeSlider.value);
	signalGraphView.updateValues();
});
document.getElementById('buttonRestart').addEventListener('click', function(e) {
	console.log("Restart");
	elmDebugger.restart();
	refreshDebuggerUI();
});
document.getElementById('buttonPause').addEventListener('click', function(e) {
	console.log("Pause");
	elmDebugger.pause();
	refreshDebuggerUI();
});
document.getElementById('buttonContinue').addEventListener('click', function(e) {
	console.log("Continue");
	elmDebugger.kontinue();
});
document.getElementById('buttonStep').addEventListener('click', function(e) {
	console.log("Step");
	elmDebugger.step();
});


function refreshDebuggerUI() {
	signalGraphView.updateValues();
	timeSlider.max = elmDebugger.getMaxSteps();
	if (elmDebugger.getPaused()) {
		timeSlider.disabled = false;
	}
	else {
		timeSlider.disabled = true;
		timeSlider.value = timeSlider.max;
	}
}

function startDebugging(elmWindow) {
	console.log("Debugger started");
	elmDebugger = elmWindow.Elm.Debugger;
	signalGraphView = createSignalGraphView(elmWindow.Elm, elmDebugger);
}

parent.window.addEventListener("message", function(e) {
	if (e.data == "elmDebuggerInit") {
		startDebugging(e.source);
	}
	else if (e.data == "elmNotify") {
		refreshDebuggerUI();
	}
}, false);

</script>
</body>
</html>